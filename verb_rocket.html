<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Verb Rocket - Quiz Mode</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a playful look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            display: flex;
            flex-direction: column; /* Allow content stacking */
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
        }
        .game-container {
            max-width: 450px; /* Slightly wider for the longer subjects */
            width: 100%;
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        .question-box {
            background-color: #e0f7fa; /* Pale cyan */
            border: 3px solid #00bcd4;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .pronoun {
            font-size: 1.5rem;
            font-weight: bold;
            color: #3f51b5; /* Indigo */
            margin-bottom: 5px;
        }
        .verb-stem {
            font-size: 3rem;
            font-weight: 900;
            color: #ff5722; /* Deep orange */
            letter-spacing: 2px;
            text-shadow: 2px 2px #ffcdd2;
        }
        .choice-button {
            transition: all 0.15s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .choice-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        .choice-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        /* Rocket Launch Animation */
        @keyframes launch {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-200px); opacity: 0; }
        }
        .launching .rocket-icon {
            animation: launch 0.5s ease-in-out forwards;
        }
        .message-box {
            min-height: 50px;
            display: flex;
            flex-direction: column; /* Allows content stacking */
            justify-content: center;
            align-items: flex-start; /* Aligns text left inside the box */
            font-weight: 700;
            border-radius: 10px;
            margin-top: 15px;
            padding: 10px;
            transition: background-color 0.3s, color 0.3s;
            font-size: 0.9rem;
            text-align: left; /* Ensures text is left-aligned */
        }
        .message-box h4 {
            font-weight: 900;
            margin-top: 8px;
            margin-bottom: 4px;
            font-size: 1.0rem;
        }
        .message-box ul {
            list-style-type: disc;
            margin-left: 20px;
            font-weight: normal;
        }
        .score-display {
            background-color: #3f51b5;
            color: white;
            padding: 8px 15px;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            margin-bottom: 15px;
            display: inline-block;
        }
        .rocket-icon {
            font-size: 4rem;
            line-height: 1;
            transition: transform 0.5s;
        }
    </style>
</head>
<body>

    <div class="game-container">
        <h1 class="text-3xl font-bold text-gray-800 mb-4">🚀 The Verb Rocket - Quiz Practice 🚀</h1>
        <div class="score-display">Score: <span id="score">0</span></div>

        <!-- Question Display -->
        <div class="question-box">
            <div id="rocket-area" class="flex flex-col items-center">
                <div class="rocket-icon">
                    <span id="rocket-emoji">🚀</span>
                </div>
                <!-- This will now show complex subjects like "LA FILLE" or "NOUS" -->
                <p class="pronoun" id="current-subject">JE</p> 
                <p class="verb-stem" id="verb-stem">PARL</p>
            </div>
        </div>

        <!-- Choice Buttons -->
        <div id="choice-buttons" class="grid grid-cols-3 gap-3">
            <!-- Buttons will be generated here -->
        </div>

        <!-- Feedback Message -->
        <div id="message" class="message-box bg-gray-100 text-gray-700">Choose the ending to launch the rocket!</div>
    </div>

    <!-- Conjugation Tracker -->
    <div class="game-container" id="tracker-container">
        <h3 class="font-bold text-xl text-yellow-800 mb-2">💡 Practice Tracker (Mistakes)</h3>
        <div id="error-list" class="grid grid-cols-2 gap-x-4 gap-y-1 text-base">
            <!-- Tracker items will go here -->
        </div>
        <p class="text-xs text-gray-500 mt-2">Focus on the pronouns with the highest numbers!</p>
    </div>

    <script>
        // --- GAME DATA ---
        
        const verbs = ["regarder", "penser", "marcher", "adorer", "écouter", "raconter", "manger", "étudier", "préférer", "jouer", "travailler", "acheter", "briller", "chanter"];
        
        // English translations for rich feedback
        const englishInfinitiveMap = {
            "regarder": "to watch/look at", "penser": "to think", "marcher": "to walk", "adorer": "to love/adore",
            "écouter": "to listen", "raconter": "to tell/recount", "manger": "to eat", "étudier": "to study",
            "préférer": "to prefer", "jouer": "to play", "travailler": "to work", "acheter": "to buy",
            "briller": "to shine", "chanter": "to sing"
        };
        
        // The master conjugation map (using simple pronoun keys)
        const conjugationMap = {
            "je": "e",
            "tu": "es",
            "il/elle/on": "e",
            "nous": "ons",
            "vous": "ez",
            "ils/elles": "ent"
        };
        
        // Reverse map for generating context about incorrect answers
        const endingToPronounMap = {
            "e": "Je, Il, Elle, On",
            "es": "Tu",
            "ons": "Nous",
            "ez": "Vous",
            "ent": "Ils, Elles"
        };

        const allEndings = Array.from(new Set(Object.values(conjugationMap))); 

        // New: Subject Map to use complex subjects from the quiz but map them to the correct conjugation key
        const subjectMap = [
            { subject: "Je", key: "je" },
            { subject: "Tu", key: "tu" },
            { subject: "Nous", key: "nous" },
            { subject: "Vous", key: "vous" },
            { subject: "Elle", key: "il/elle/on" }, 
            { subject: "On", key: "il/elle/on" }, 
            { subject: "Ils", key: "ils/elles" },
            { subject: "La fille", key: "il/elle/on" }, 
            { subject: "L'équipe", key: "il/elle/on" }, 
            { subject: "Le soleil", key: "il/elle/on" }, 
            { subject: "Mamie et papy", key: "ils/elles" }, 
            { subject: "Les élèves", key: "ils/elles" }, 
        ];

        // --- DOM Elements ---
        const scoreDisplay = document.getElementById('score');
        const subjectDisplay = document.getElementById('current-subject');
        const verbStemDisplay = document.getElementById('verb-stem');
        const choiceButtonsContainer = document.getElementById('choice-buttons');
        const messageBox = document.getElementById('message');
        const rocketArea = document.getElementById('rocket-area');
        const rocketEmoji = document.getElementById('rocket-emoji');
        const nextQuestionButtonId = 'next-question-button';

        // --- GAME STATE ---
        let score = 0;
        let currentCorrectEnding = "";
        let currentPronounKey = ""; 
        let currentInfinitive = "";
        let isProcessing = false;
        
        // Tracker keys must match conjugationMap keys
        let errorTracker = {
            "je": 0, "tu": 0, "il/elle/on": 0, "nous": 0, "vous": 0, "ils/elles": 0
        };

        // --- HELPER FUNCTIONS ---
        
        /**
         * Returns a simple English translation of the conjugated phrase.
         */
        function getEnglishTranslation(infinitive, pronounKey) {
            const baseTranslation = englishInfinitiveMap[infinitive] || "to act";
            const action = baseTranslation.replace('to ', '');
            
            // Simple logic to add 's' for third person singular in English
            const conjugatedAction = (pronounKey === 'il/elle/on') ? action + 's' : action;

            switch (pronounKey) {
                case 'je': return `I ${conjugatedAction}`;
                case 'tu': return `You ${conjugatedAction}`;
                case 'il/elle/on': 
                    if (infinitive === "briller") return `It ${conjugatedAction}`; // For Le soleil
                    return `He/She/It ${conjugatedAction}`;
                case 'nous': return `We ${conjugatedAction}`;
                case 'vous': return `You all ${conjugatedAction}`;
                case 'ils/elles': return `They ${conjugatedAction}`;
                default: return `[${baseTranslation}]`;
            }
        }
        
        /**
         * Renders the current state of the error tracker. (Unchanged)
         */
        function renderErrorTracker() {
            const errorList = document.getElementById('error-list');
            errorList.innerHTML = '';
            
            const sortedErrors = Object.entries(errorTracker)
                .map(([pronoun, count]) => ({ pronoun: pronoun.toUpperCase().replace('/', ' / '), count }))
                .sort((a, b) => b.count - a.count);

            sortedErrors.forEach(item => {
                const itemDiv = document.createElement('div');
                const textColor = item.count > 0 ? 'text-red-600 font-bold' : 'text-gray-600';
                itemDiv.className = `flex justify-between ${textColor} border-b border-yellow-200 pb-1`;
                
                itemDiv.innerHTML = `<span class="pr-2">${item.pronoun}:</span><span>${item.count}</span>`;
                errorList.appendChild(itemDiv);
            });
        }

        /**
         * Shuffles an array in place. (Unchanged)
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        /**
         * Creates and displays the 'Next Question' button. (Unchanged)
         */
        function showNextQuestionButton() {
            const existingButton = document.getElementById(nextQuestionButtonId);
            if (existingButton) existingButton.remove();

            const nextButton = document.createElement('button');
            nextButton.textContent = 'Launch Next Rocket! ➡️';
            nextButton.className = 'mt-4 p-3 w-full bg-pink-500 text-white font-bold rounded-xl shadow-lg hover:bg-pink-600 transition';
            nextButton.id = nextQuestionButtonId;

            nextButton.addEventListener('click', () => {
                nextButton.remove(); 
                generateQuestion();
                isProcessing = false;
                Array.from(choiceButtonsContainer.children).forEach(btn => btn.disabled = false);
            });

            rocketArea.parentNode.parentNode.insertBefore(nextButton, messageBox.nextSibling); 
        }


        /**
         * Selects a random verb, pronoun, and determines the correct ending.
         */
        function generateQuestion() {
            // Reset visuals
            rocketEmoji.style.transform = 'translateY(0)';
            rocketEmoji.style.opacity = '1';
            rocketArea.classList.remove('launching');
            messageBox.className = "message-box bg-gray-100 text-gray-700";
            messageBox.textContent = "Choose the ending to launch the rocket!";
            
            const nextButton = document.getElementById(nextQuestionButtonId);
            if (nextButton) nextButton.remove();

            // 1. Pick a random subject and key
            const randomSubjectObject = subjectMap[Math.floor(Math.random() * subjectMap.length)];
            const subject = randomSubjectObject.subject;
            const pronounKey = randomSubjectObject.key; 

            // 2. Pick a random verb (and get its stem)
            const randomVerb = verbs[Math.floor(Math.random() * verbs.length)];
            const stem = randomVerb.slice(0, -2);

            // 3. Find the correct ending
            const correctEnding = conjugationMap[pronounKey];

            // Update game state
            currentCorrectEnding = correctEnding;
            currentPronounKey = pronounKey;
            currentInfinitive = randomVerb; // Store the full infinitive for translation

            // Update display
            subjectDisplay.textContent = subject.toUpperCase();
            verbStemDisplay.textContent = stem.toUpperCase();

            // Generate options
            generateChoiceButtons(correctEnding);
        }

        /**
         * Creates choice buttons with the correct and incorrect endings. (Unchanged)
         */
        function generateChoiceButtons(correctEnding) {
            choiceButtonsContainer.innerHTML = '';
            
            let incorrectEndings = allEndings.filter(e => e !== correctEnding);
            shuffleArray(incorrectEndings);
            
            const options = [correctEnding, ...incorrectEndings.slice(0, 2)];
            shuffleArray(options); 

            options.forEach(ending => {
                const button = document.createElement('button');
                button.textContent = ending.toUpperCase();
                button.className = "choice-button p-3 text-xl font-bold rounded-full text-white bg-indigo-500 hover:bg-indigo-600";
                button.setAttribute('data-ending', ending);
                
                button.addEventListener('click', () => {
                    checkAnswer(ending, button);
                });
                choiceButtonsContainer.appendChild(button);
            });
        }
        
        /**
         * Builds the detailed rule explanation for correct/incorrect answers.
         */
        function buildRuleExplanation(subject, pronounKey, correctEnding, currentInfinitive, isCorrect) {
            const endingText = correctEnding.toUpperCase();
            const fullFrench = subject.toUpperCase() + ' ' + verbStemDisplay.textContent + endingText;
            const englishTranslation = getEnglishTranslation(currentInfinitive, pronounKey);
            let explanation = '';

            // --- Part 1: Core Rule ---
            if (isCorrect) {
                explanation += `<span class="text-xl">✅ ${fullFrench}</span>`;
            } else {
                explanation += `<span class="text-xl">❌ The correct answer is **${fullFrench}**.</span>`;
            }
            explanation += `<p class="text-base text-gray-500 italic mb-3"> (English: "${englishTranslation}")</p>`;
            
            // Core conjugation explanation
            if (pronounKey === 'il/elle/on') {
                if (subject === 'L\'ÉQUIPE' || subject === 'LE SOLEIL' || subject === 'LA FILLE' || subject === 'ELLE' || subject === 'ON') {
                    explanation += `**Rule:** **${subject}** is a **singular** subject (like 'team' or 'sun'). It always acts like **IL / ELLE** and takes the simple ending **-${endingText}**.`;
                } else {
                    explanation += `**Rule:** **${subject}** is a singular subject, acting like **IL / ELLE**. It takes the ending **-${endingText}**.`;
                }
            } else if (pronounKey === 'ils/elles') {
                if (subject === 'MAMIE ET PAPY' || subject === 'LES ÉLÈVES' || subject === 'ILS') {
                    explanation += `**Rule:** **${subject}** is a **plural** subject (two or more people/things). It acts like **ILS / ELLES** and takes the **-${endingText}** ending.`;
                } else {
                     explanation += `**Rule:** The ending for **${subject}** is always **-${endingText}**.`;
                }
            } else {
                explanation += `**Rule:** The ending for **${subject}** is always **-${endingText}**.`;
            }
            
            // --- Part 2: Context for Other Endings ---
            const options = Array.from(choiceButtonsContainer.children);
            let contextHTML = '<h4>Other Endings Practice:</h4><ul>';
            
            // Filter options to get the ones that were visible to the player
            const visibleEndings = options.map(btn => btn.getAttribute('data-ending'));
            
            visibleEndings.forEach(ending => {
                const pronouns = endingToPronounMap[ending] || 'N/A';
                
                // Highlight the correct one in the list
                const highlight = (ending === correctEnding) ? 'font-bold text-green-700' : '';
                
                contextHTML += `<li class="${highlight}">The **-${ending.toUpperCase()}** ending is used for **${pronouns}**.</li>`;
            });
            contextHTML += '</ul>';

            return explanation + contextHTML;
        }


        /**
         * Checks the user's answer and provides feedback.
         */
        function checkAnswer(chosenEnding, button) {
            if (isProcessing) return;
            isProcessing = true;

            Array.from(choiceButtonsContainer.children).forEach(btn => btn.disabled = true);

            const subject = subjectDisplay.textContent;
            let explanationContent;
            
            if (chosenEnding === currentCorrectEnding) {
                // Correct Answer!
                score++;
                scoreDisplay.textContent = score;

                explanationContent = buildRuleExplanation(subject, currentPronounKey, currentCorrectEnding, currentInfinitive, true);
                
                // Visual feedback for correctness
                button.className = "choice-button p-3 text-xl font-bold rounded-full text-white bg-green-500";
                messageBox.className = "message-box bg-green-100 text-green-700";
                
                // Rocket Launch Animation
                rocketArea.classList.add('launching');

            } else {
                // Incorrect Answer
                
                // Increment error tracker
                errorTracker[currentPronounKey]++;
                renderErrorTracker();
                
                explanationContent = buildRuleExplanation(subject, currentPronounKey, currentCorrectEnding, currentInfinitive, false);
                
                // Visual feedback
                button.className = "choice-button p-3 text-xl font-bold rounded-full text-white bg-red-500";
                messageBox.className = "message-box bg-red-100 text-red-700";
                
                // Find and highlight the correct button
                const correctButton = Array.from(choiceButtonsContainer.children).find(btn => 
                    btn.getAttribute('data-ending') === currentCorrectEnding
                );
                if (correctButton) {
                    correctButton.className = "choice-button p-3 text-xl font-bold rounded-full text-white bg-green-500 animate-pulse";
                }
            }
            
            messageBox.innerHTML = explanationContent;

            // Always show the next question button after checking the answer
            showNextQuestionButton();
        }

        // --- INITIALIZATION ---
        window.onload = function() {
            generateQuestion();
            renderErrorTracker();
        };

    </script>
</body>
</html>
